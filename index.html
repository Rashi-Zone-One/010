<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VillainHub - ‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å‡∏î‡∏∑‡πâ‡∏≠</title>
  
  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&amp;family=Kanit:wght@300;400;600&amp;display=swap" rel="stylesheet">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Mali', cursive;
    }
    
    .font-kanit {
      font-family: 'Kanit', sans-serif;
    }
    
    /* Floating Animation */
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }
    
    .float-animation {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float-delayed {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(-5deg); }
    }
    
    .float-delayed {
      animation: float-delayed 8s ease-in-out infinite;
    }
    
    /* Card Hover Effect */
    .villain-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .villain-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .villain-card:hover .action-btn {
      opacity: 1;
      visibility: visible;
    }
    
    .action-btn {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    /* Image Preview */
    .image-preview {
      position: relative;
      overflow: hidden;
    }
    
    .image-preview img {
      object-fit: cover;
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ec4899;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal Styles */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Loading Overlay */
    .loading-overlay {
      background: rgba(255, 255, 255, 0.95);
    }

    /* Upload Progress */
    .upload-progress {
      transition: width 0.3s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-orange-50">
  
  <!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 z-50 loading-overlay flex items-center justify-center">
   <div class="text-center">
    <div class="text-6xl mb-4 animate-bounce">
     üòà
    </div>
    <div class="spinner mx-auto mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
    <p class="text-pink-600 font-bold text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    <p class="text-gray-500 text-sm font-kanit mt-2">Connecting...</p>
   </div>
  </div>
  
  <!-- Background Decoration -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden z-0">
   <div class="absolute top-10 left-10 text-6xl opacity-20 float-animation">
    ‚òÅÔ∏è
   </div>
   <div class="absolute top-32 right-20 text-5xl opacity-20 float-delayed">
    ‚≠ê
   </div>
   <div class="absolute bottom-20 left-1/4 text-7xl opacity-15 float-animation">
    ‚òÅÔ∏è
   </div>
   <div class="absolute top-1/3 right-10 text-4xl opacity-25 float-delayed">
    ‚ú®
   </div>
   <div class="absolute bottom-32 right-1/3 text-6xl opacity-20 float-animation">
    üåü
   </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editUserModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
   <div class="modal-content bg-white rounded-3xl shadow-2xl max-w-md w-full p-8">
    <div class="flex justify-between items-center mb-6">
     <h3 class="text-2xl font-bold text-purple-600 flex items-center"><i data-lucide="user-cog" class="w-6 h-6 mr-2"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3><button onclick="closeEditUserModal()" class="text-gray-400 hover:text-gray-600"> <i data-lucide="x" class="w-6 h-6"></i> </button>
    </div>
    <form id="editUserForm" class="space-y-4">
     <div><label for="editUserName" class="block text-sm font-kanit text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input type="text" id="editUserName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none" required>
     </div>
     <div><label for="editUserEmail" class="block text-sm font-kanit text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input type="email" id="editUserEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none bg-gray-100" readonly>
      <p class="text-xs text-gray-500 mt-1 font-kanit">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏î‡πâ</p>
     </div>
     <div><label for="editUserRole" class="block text-sm font-kanit text-gray-700 mb-2">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label> <select id="editUserRole" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none"> <option value="user">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option> <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</option> </select>
     </div>
     <div class="flex space-x-3 pt-4"><button type="submit" id="editUserSubmitBtn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl shadow-md active:scale-95 transition font-kanit flex items-center justify-center"> <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span> </button> <button type="button" onclick="closeEditUserModal()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-3 rounded-xl shadow-md active:scale-95 transition font-kanit"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
     </div>
    </form>
   </div>
  </div>
  
  <!-- Main Container -->
  <div class="relative z-10 h-full overflow-auto">
   <!-- Navbar -->
   <nav class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex justify-between items-center h-20">
      <div class="flex items-center space-x-3">
       <div class="text-4xl">
        üòà
       </div>
       <div>
        <h1 class="text-2xl font-bold text-pink-600">VillainHub</h1>
        <p class="text-xs text-gray-500 font-kanit">‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å‡∏î‡∏∑‡πâ‡∏≠</p>
       </div>
      </div>
      <div class="flex items-center space-x-4"><span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm font-kanit flex items-center"> <i data-lucide="sheet" class="w-4 h-4 mr-1"></i> Google Sheets </span> <span id="userDisplay" class="text-sm text-gray-600 font-kanit hidden"></span> <button id="manageUsersBtn" class="hidden bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-2xl shadow-md active:scale-95 transition items-center space-x-2"> <i data-lucide="users-cog" class="w-5 h-5"></i> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span> </button> <button id="toggleFormBtn" class="hidden bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-2xl shadow-md active:scale-95 transition items-center space-x-2"> <i data-lucide="user-plus" class="w-5 h-5"></i> <span>‡πÅ‡∏≠‡∏ö‡∏ü‡πâ‡∏≠‡∏á</span> </button> <button id="logoutBtn" class="hidden bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-2xl shadow-md active:scale-95 transition"> <i data-lucide="log-out" class="w-5 h-5"></i> </button>
      </div>
     </div>
    </div>
   </nav>
   
   <!-- Login Screen -->
   <div id="loginScreen" class="max-w-md mx-auto mt-20 px-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8">
     <div class="text-center mb-6">
      <div class="text-6xl mb-4">
       üòà
      </div>
      <h2 class="text-3xl font-bold text-pink-600 mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
      <p class="text-gray-600 font-kanit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö VillainHub (Sheets)</p>
     </div>
     <form id="loginForm" class="space-y-4">
      <div><label for="loginUsername" class="block text-sm font-kanit text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="loginUsername" placeholder="Username" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none" required>
      </div>
      <div><label for="loginPassword" class="block text-sm font-kanit text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none" required>
      </div><button type="submit" id="loginSubmitBtn" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-xl shadow-md active:scale-95 transition font-kanit flex items-center justify-center"> <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span> </button>
      <div class="text-center">
       <p class="text-gray-600 font-kanit text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <button type="button" id="goToRegisterBtn" class="text-pink-600 hover:text-pink-700 font-bold">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button></p>
      </div>
     </form>
    </div>
   </div>
   
   <!-- Register Screen -->
   <div id="registerScreen" class="hidden max-w-md mx-auto mt-20 px-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8">
     <div class="text-center mb-6">
      <div class="text-6xl mb-4">
       ‚ú®
      </div>
      <h2 class="text-3xl font-bold text-orange-600 mb-2">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
      <p class="text-gray-600 font-kanit">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà (Sheets)</p>
     </div>
     <form id="registerForm" class="space-y-4">
      <div><label for="registerUsername" class="block text-sm font-kanit text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="registerUsername" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none" required>
      </div>
      <div><label for="registerPassword" class="block text-sm font-kanit text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="registerPassword" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none" required>
      </div>
      <div><label for="registerConfirmPassword" class="block text-sm font-kanit text-gray-700 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="registerConfirmPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none" required>
      </div><button type="submit" id="registerSubmitBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl shadow-md active:scale-95 transition font-kanit flex items-center justify-center"> <span>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span> </button>
      <div class="text-center">
       <p class="text-gray-600 font-kanit text-sm">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <button type="button" id="goToLoginBtn" class="text-orange-600 hover:text-orange-700 font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></p>
      </div>
     </form>
    </div>
   </div>
   
   <!-- User Management Screen (Admin Only) -->
   <div id="userManagementScreen" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
     <div class="bg-white rounded-3xl shadow-2xl p-8">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-2xl font-bold text-purple-600 flex items-center"><i data-lucide="users-cog" class="w-6 h-6 mr-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2><button id="backToMainBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl shadow-md active:scale-95 transition flex items-center"> <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö </button>
      </div>
      <div id="usersTableContainer" class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="bg-purple-50">
          <th class="px-4 py-3 text-left text-sm font-kanit text-purple-700">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="px-4 py-3 text-left text-sm font-kanit text-purple-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
          <th class="px-4 py-3 text-left text-sm font-kanit text-purple-700">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
          <th class="px-4 py-3 text-left text-sm font-kanit text-purple-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
          <th class="px-4 py-3 text-center text-sm font-kanit text-purple-700">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
         </tr>
        </thead>
        <tbody id="usersTableBody"><!-- Users will be rendered here -->
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </div>
   
   <!-- Main Content -->
   <div id="mainContent" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
     <!-- Search Bar -->
     <div class="mb-8">
      <div class="relative"><input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡πÅ‡∏Å‡πä‡∏á, ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏µ‡∏£‡∏Å‡∏£‡∏£‡∏°..." class="w-full px-6 py-4 text-lg border-2 border-pink-200 rounded-2xl focus:border-pink-400 focus:outline-none shadow-lg bg-white">
      </div>
     </div>
     <!-- Form Section (Toggle) -->
     <div id="formSection" class="mb-8 hidden">
      <div class="bg-white rounded-3xl shadow-2xl p-8">
       <h2 class="text-2xl font-bold text-pink-600 mb-6 flex items-center"><i data-lucide="file-edit" class="w-6 h-6 mr-2"></i> <span id="formTitle">‡πÅ‡∏≠‡∏ö‡∏ü‡πâ‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏î‡∏∑‡πâ‡∏≠</span></h2>
       <form id="villainForm" class="space-y-6"><input type="hidden" id="editDocId"> <!-- Image Upload -->
        <div><label class="block text-sm font-kanit text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)</label>
         <div class="flex items-start space-x-4">
          <div id="imagePreview" class="w-32 h-32 bg-gray-100 rounded-2xl flex items-center justify-center overflow-hidden"><span class="text-gray-400 text-sm text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>
          </div>
          <div class="flex-1"><input type="file" id="imageInput" accept="image/*" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none">
           <p class="text-xs text-gray-500 mt-1 font-kanit">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG (‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)</p><!-- Upload Progress -->
           <div id="uploadProgress" class="hidden mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2">
             <div id="uploadProgressBar" class="upload-progress bg-pink-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p id="uploadProgressText" class="text-xs text-pink-600 mt-1 font-kanit">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î... 0%</p>
           </div>
          </div>
         </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
         <div><label for="nameInput" class="block text-sm font-kanit text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠/‡∏â‡∏≤‡∏¢‡∏≤</label> <input type="text" id="nameInput" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≠‡∏°‡∏ß‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none">
         </div>
         <div><label for="gangInput" class="block text-sm font-kanit text-gray-700 mb-2">‡πÅ‡∏Å‡πä‡∏á/‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</label> <input type="text" id="gangInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Å‡πä‡∏á‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÜ" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none">
         </div>
        </div>
        <div><label for="locationInput" class="block text-sm font-kanit text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏à‡∏≠</label> <input type="text" id="locationInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none">
        </div>
        <div><label for="crimeInput" class="block text-sm font-kanit text-gray-700 mb-2">‡∏ß‡∏µ‡∏£‡∏Å‡∏£‡∏£‡∏°</label> <textarea id="crimeInput" rows="3" placeholder="‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤‡∏ß‡∏µ‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏≥..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none resize-none"></textarea>
        </div>
        <div><label for="punishmentInput" class="block text-sm font-kanit text-gray-700 mb-2">‡∏ö‡∏ó‡∏•‡∏á‡πÇ‡∏ó‡∏©/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label> <select id="punishmentInput" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:outline-none"> <option value="‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á">üü° ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</option> <option value="‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á">üü® ‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</option> <option value="‡πÉ‡∏ö‡πÅ‡∏î‡∏á">üü• ‡πÉ‡∏ö‡πÅ‡∏î‡∏á</option> <option value="‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß">‚è∏Ô∏è ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</option> <option value="‡∏õ‡∏è‡∏¥‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß">‚úÖ ‡∏õ‡∏è‡∏¥‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß</option> </select>
        </div>
        <div class="flex space-x-4"><button type="submit" id="villainSubmitBtn" class="flex-1 bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-xl shadow-md active:scale-95 transition font-kanit flex items-center justify-center"> <span id="submitBtnText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span> </button> <button type="button" id="cancelEditBtn" class="hidden flex-1 bg-gray-400 hover:bg-gray-500 text-white py-3 rounded-xl shadow-md active:scale-95 transition font-kanit"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
        </div>
       </form>
      </div>
     </div>
     <!-- Cards Display -->
     <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Cards will be dynamically generated here -->
     </div>
     <!-- Empty State -->
     <div id="emptyState" class="hidden text-center py-20">
      <div class="text-8xl mb-4">
       üòá
      </div>
      <h3 class="text-2xl font-bold text-gray-400 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h3>
      <p class="text-gray-500 font-kanit">‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÅ‡∏≠‡∏ö‡∏ü‡πâ‡∏≠‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Initialize Lucide Icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // ==========================================
    // ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (CONFIG)
    // ==========================================
    
    // 1. ‡∏ô‡∏≥ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Google Apps Script ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (Web App URL)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwt7--LBCGbT3_PAyTlSiuYEkVN9_bYzSzDd2A4Duzjo7g1W_RztRfGqfNYnF2Ejavj/exec'; 

    // 2. ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Redirect ‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    const REDIRECT_URL = 'https://www.google.com'; 

    // ==========================================

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDQsubjHQJkFbZmOHwVtwVzfIBapJxKpzw",
      authDomain: "naughtyclub-fd51b.firebaseapp.com",
      projectId: "naughtyclub-fd51b",
      storageBucket: "naughtyclub-fd51b.firebasestorage.app",
      messagingSenderId: "541396856072",
      appId: "1:541396856072:web:60c79b45adab05a6db10bd",
      measurementId: "G-10DL8850KT"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Global State
    let allVillains = [];
    let allUsers = [];
    let currentUser = null;
    let editingVillain = null;
    let editingUser = null;
    let currentImageFile = null;
    let currentImageUrl = null;
    
    // Listeners
    let unsubscribeVillains = null;
    let unsubscribeUsers = null;

    // DOM Elements
    const loadingScreen = document.getElementById('loadingScreen');
    const loginScreen = document.getElementById('loginScreen');
    const registerScreen = document.getElementById('registerScreen');
    const userManagementScreen = document.getElementById('userManagementScreen');
    const mainContent = document.getElementById('mainContent');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    
    // Changed Element IDs for Login/Register
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    const registerUsername = document.getElementById('registerUsername');
    const registerPassword = document.getElementById('registerPassword');
    const registerConfirmPassword = document.getElementById('registerConfirmPassword');
    const registerSubmitBtn = document.getElementById('registerSubmitBtn');
    
    const goToRegisterBtn = document.getElementById('goToRegisterBtn');
    const goToLoginBtn = document.getElementById('goToLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userDisplay = document.getElementById('userDisplay');
    const manageUsersBtn = document.getElementById('manageUsersBtn');
    const backToMainBtn = document.getElementById('backToMainBtn');
    const toggleFormBtn = document.getElementById('toggleFormBtn');
    const formSection = document.getElementById('formSection');
    const villainForm = document.getElementById('villainForm');
    const villainSubmitBtn = document.getElementById('villainSubmitBtn');
    const searchInput = document.getElementById('searchInput');
    const cardsContainer = document.getElementById('cardsContainer');
    const emptyState = document.getElementById('emptyState');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const formTitle = document.getElementById('formTitle');
    const submitBtnText = document.getElementById('submitBtnText');
    const usersTableBody = document.getElementById('usersTableBody');
    const editUserModal = document.getElementById('editUserModal');
    const editUserForm = document.getElementById('editUserForm');
    const editUserName = document.getElementById('editUserName');
    const editUserEmail = document.getElementById('editUserEmail');
    const editUserRole = document.getElementById('editUserRole');
    const editUserSubmitBtn = document.getElementById('editUserSubmitBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    const uploadProgressText = document.getElementById('uploadProgressText');

    // Initialize App
    async function initApp() {
        console.log('üöÄ Initializing App...');
        
        // Check for local storage user first (Sheets Login)
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            // Auto sign-in to firebase anonymously for Firestore access
            await auth.signInAnonymously().catch(e => console.error("Anon auth failed", e));
            showMainContent();
            setupVillainsListener();
            if (currentUser.role === 'admin') setupUsersListener(); // Fix: Call this for admin
        } else {
            showLoginScreen();
        }
        
        loadingScreen.classList.add('hidden');
    }

    // Setup Villains Listener
    function setupVillainsListener() {
      if (unsubscribeVillains) unsubscribeVillains();
      
      unsubscribeVillains = db.collection('villains').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
        allVillains = [];
        snapshot.forEach((doc) => {
          allVillains.push({ id: doc.id, ...doc.data() });
        });
        console.log('üìä Villains updated:', allVillains.length);
        if (!mainContent.classList.contains('hidden')) {
          renderVillainCards();
        }
      }, (error) => {
          console.error("Error listening to villains:", error);
      });
    }

    // Setup Users Listener (Updated)
    function setupUsersListener() {
      if (unsubscribeUsers) unsubscribeUsers();
      
      unsubscribeUsers = db.collection('users').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
        allUsers = [];
        snapshot.forEach((doc) => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });
        console.log('üë• Users updated:', allUsers.length);
        // Only render if management screen is visible to save resources
        if (!userManagementScreen.classList.contains('hidden')) {
          renderUsersTable();
        }
      }, (error) => {
          console.error("Error listening to users:", error);
      });
    }

    // Switch to Register Screen
    goToRegisterBtn.addEventListener('click', () => {
      loginScreen.classList.add('hidden');
      registerScreen.classList.remove('hidden');
    });

    // Switch to Login Screen
    goToLoginBtn.addEventListener('click', () => {
      registerScreen.classList.add('hidden');
      loginScreen.classList.remove('hidden');
    });

    // Show Login Screen
    function showLoginScreen() {
        loginScreen.classList.remove('hidden');
        registerScreen.classList.add('hidden');
        mainContent.classList.add('hidden');
        userManagementScreen.classList.add('hidden');
        toggleFormBtn.classList.add('hidden');
        manageUsersBtn.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        userDisplay.classList.add('hidden');
    }

    // ==========================================
    // üîë LOGIN SYSTEM (Google Sheets)
    // ==========================================
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = loginUsername.value.trim();
      const password = loginPassword.value.trim();

      if (!username || !password) {
        Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' });
        return;
      }

      // UI Loading
      loginSubmitBtn.disabled = true;
      loginSubmitBtn.innerHTML = '<div class="spinner mx-auto"></div>';

      try {
        const url = `${APPS_SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
            // Login Success
            currentUser = { 
                name: username, 
                email: username, 
                role: result.role || 'user' // ‡∏£‡∏±‡∏ö Role ‡∏à‡∏≤‡∏Å Google Sheets
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Sign in to Firebase Anonymously for Firestore Access
            await auth.signInAnonymously().catch(err => console.error("Firebase Anon Auth Error", err));

            Swal.fire({
                icon: 'success',
                title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå...',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                if (REDIRECT_URL && REDIRECT_URL !== '') {
                    window.location.href = REDIRECT_URL;
                } else {
                    showMainContent();
                    setupVillainsListener();
                    if (currentUser.role === 'admin') setupUsersListener(); // Fix: Call this for admin
                    loginForm.reset();
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: result.message || '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
            });
        }

      } catch (error) {
        console.error('Login error:', error);
        Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL'
        });
      }

      loginSubmitBtn.disabled = false;
      loginSubmitBtn.innerHTML = '<span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>';
    });

    // ==========================================
    // üìù REGISTER SYSTEM (Google Sheets)
    // ==========================================
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = registerUsername.value.trim();
      const password = registerPassword.value.trim();
      const confirmPassword = registerConfirmPassword.value.trim();

      if (!username || !password || !confirmPassword) {
        Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' });
        return;
      }

      if (password !== confirmPassword) {
        Swal.fire({ icon: 'error', title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á' });
        return;
      }

      registerSubmitBtn.disabled = true;
      registerSubmitBtn.innerHTML = '<div class="spinner mx-auto"></div>';
      
      Swal.fire({
          title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
          allowOutsideClick: false,
          didOpen: () => {
              Swal.showLoading();
          }
      });

      try {
        const url = `${APPS_SCRIPT_URL}?action=register&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            }).then(() => {
                registerScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                registerForm.reset();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
            });
        }

      } catch (error) {
        console.error('Register error:', error);
        Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ'
        });
      }

      registerSubmitBtn.disabled = false;
      registerSubmitBtn.innerHTML = '<span>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>';
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      const result = await Swal.fire({
        title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#ec4899',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });

      if (result.isConfirmed) {
        currentUser = null;
        localStorage.removeItem('currentUser');
        await auth.signOut(); // Sign out from Firebase too
        showLoginScreen();
        if (unsubscribeVillains) unsubscribeVillains();
        if (unsubscribeUsers) unsubscribeUsers();
      }
    });

    // Show Main Content
    function showMainContent() {
      loginScreen.classList.add('hidden');
      registerScreen.classList.add('hidden');
      userManagementScreen.classList.add('hidden');
      mainContent.classList.remove('hidden');
      toggleFormBtn.classList.remove('hidden');
      toggleFormBtn.classList.add('flex');
      logoutBtn.classList.remove('hidden');
      userDisplay.classList.remove('hidden');
      userDisplay.textContent = currentUser.name || currentUser.email;
      
      if (currentUser.role === 'admin') {
        userDisplay.textContent += ' (Admin)';
        userDisplay.classList.add('text-pink-600', 'font-bold');
        manageUsersBtn.classList.remove('hidden');
        manageUsersBtn.classList.add('flex');
      } else {
        manageUsersBtn.classList.add('hidden');
      }
      
      renderVillainCards();
    }

    // Manage Users (Admin Only)
    manageUsersBtn.addEventListener('click', () => {
      if (currentUser.role !== 'admin') return;
      mainContent.classList.add('hidden');
      userManagementScreen.classList.remove('hidden');
      renderUsersTable();
    });

    // Back to Main
    backToMainBtn.addEventListener('click', () => {
      userManagementScreen.classList.add('hidden');
      mainContent.classList.remove('hidden');
    });

    // Render Users Table
    function renderUsersTable() {
      if (allUsers.length === 0) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500 font-kanit">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</td>
          </tr>
        `;
        return;
      }

      usersTableBody.innerHTML = allUsers.map(user => {
        const date = new Date(user.createdAt);
        const formattedDate = date.toLocaleDateString('th-TH', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });

        return `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3 font-kanit">${user.name}</td>
            <td class="px-4 py-3 font-kanit text-sm text-gray-600">${user.email}</td>
            <td class="px-4 py-3">
              <span class="px-3 py-1 rounded-full text-xs font-kanit ${user.role === 'admin' ? 'bg-pink-100 text-pink-700' : 'bg-blue-100 text-blue-700'}">
                ${user.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' : '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
              </span>
            </td>
            <td class="px-4 py-3 font-kanit text-sm text-gray-600">${formattedDate}</td>
            <td class="px-4 py-3 text-center">
              <div class="flex justify-center space-x-2">
                <button onclick="openEditUserModal('${user.id}')" class="text-blue-500 hover:text-blue-700" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                  <i data-lucide="edit" class="w-5 h-5"></i>
                </button>
                ${user.email !== 'admin@skr.ac.th' ? `
                  <button onclick="deleteUser('${user.id}')" class="text-red-500 hover:text-red-700" title="‡∏•‡∏ö">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');

      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Open Edit User Modal
    function openEditUserModal(userId) {
      if (currentUser.role !== 'admin') return;
      
      editingUser = allUsers.find(u => u.id === userId);
      if (!editingUser) return;

      editUserName.value = editingUser.name;
      editUserEmail.value = editingUser.email;
      editUserRole.value = editingUser.role;

      editUserModal.classList.remove('hidden');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Close Edit User Modal
    function closeEditUserModal() {
      editUserModal.classList.add('hidden');
      editingUser = null;
      editUserForm.reset();
    }

    // Edit User Form Submit
    editUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!editingUser) return;

      const name = editUserName.value.trim();
      const role = editUserRole.value;

      if (!name) {
        showToast('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á');
        return;
      }

      editUserSubmitBtn.disabled = true;
      editUserSubmitBtn.innerHTML = '<div class="spinner mx-auto"></div>';

      try {
        await db.collection('users').doc(editingUser.id).update({
          name: name,
          role: role
        });

        if (currentUser.email === editingUser.email) {
          currentUser.name = name;
          currentUser.role = role;
          userDisplay.textContent = currentUser.name || currentUser.email;
          if (currentUser.role === 'admin') {
            userDisplay.textContent += ' (Admin)';
          }
        }

        showToast('success', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
        closeEditUserModal();
      } catch (error) {
        console.error('Update user error:', error);
        showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ');
      }

      editUserSubmitBtn.disabled = false;
      editUserSubmitBtn.innerHTML = '<span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span>';
    });

    // Delete User (Admin Only) - Added missing function
    async function deleteUser(userId) {
      if (currentUser.role !== 'admin') return;

      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      const result = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
        text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${user.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });

      if (result.isConfirmed) {
        try {
          await db.collection('users').doc(userId).delete();
          showToast('success', '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
          console.error('Delete user error:', error);
          showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ');
        }
      }
    }

    // Toggle Form
    toggleFormBtn.addEventListener('click', () => {
      formSection.classList.toggle('hidden');
      if (!formSection.classList.contains('hidden')) {
        formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    // Compress Image Function (OPTIMIZED)
    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let width = img.width;
            let height = img.height;
            const maxSize = 800;
            if (width > height && width > maxSize) {
              height = (height * maxSize) / width;
              width = maxSize;
            } else if (height > maxSize) {
              width = (width * maxSize) / height;
              height = maxSize;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => {
              const compressedFile = new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
              });
              resolve(compressedFile);
            }, 'image/jpeg', 0.6);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Image Upload Preview
    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          showToast('error', '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
          imageInput.value = '';
          return;
        }
        if (!file.type.startsWith('image/')) {
          showToast('error', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
          imageInput.value = '';
          return;
        }
        imagePreview.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><div class="spinner mb-2"></div><p class="text-xs text-gray-500 text-center px-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î...</p></div>';
        try {
          const compressedFile = await compressImage(file);
          currentImageFile = compressedFile;
          const reader = new FileReader();
          reader.onload = (event) => {
            imagePreview.innerHTML = `<img src="${event.target.result}" alt="Preview" class="w-full h-full object-cover rounded-2xl">`;
          };
          reader.readAsDataURL(compressedFile);
        } catch (error) {
          showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ');
          imagePreview.innerHTML = '<span class="text-gray-400 text-sm text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>';
        }
      }
    });

    // Upload Image
    async function uploadImage(file) {
      if (!file) return null;
      try {
        const timestamp = Date.now();
        const fileName = `villains/${timestamp}_${file.name}`;
        const storageRef = storage.ref(fileName);
        uploadProgress.classList.remove('hidden');
        const uploadTask = storageRef.put(file);
        return new Promise((resolve, reject) => {
          uploadTask.on('state_changed',
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              uploadProgressBar.style.width = `${progress}%`;
              uploadProgressText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î... ${Math.round(progress)}%`;
            },
            (error) => {
              console.error('Upload error:', error);
              uploadProgress.classList.add('hidden');
              reject(error);
            },
            async () => {
              try {
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                uploadProgress.classList.add('hidden');
                uploadProgressBar.style.width = '0%';
                resolve(downloadURL);
              } catch (error) {
                uploadProgress.classList.add('hidden');
                reject(error);
              }
            }
          );
        });
      } catch (error) {
        console.error('Upload image error:', error);
        uploadProgress.classList.add('hidden');
        throw error;
      }
    }

    // Form Submit
    villainForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('nameInput').value.trim();
      const gang = document.getElementById('gangInput').value.trim();
      const location = document.getElementById('locationInput').value.trim();
      const crime = document.getElementById('crimeInput').value.trim();
      const punishment = document.getElementById('punishmentInput').value;
      villainSubmitBtn.disabled = true;
      submitBtnText.innerHTML = '<div class="spinner mx-auto"></div>';
      try {
        let imageUrl;
        if (currentImageFile) {
          imageUrl = await uploadImage(currentImageFile);
        } else if (currentImageUrl) {
          imageUrl = currentImageUrl;
        } else {
          imageUrl = `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(name)}`;
        }
        if (editingVillain) {
          await db.collection('villains').doc(editingVillain.id).update({
            name, gang, location, crime, punishment, image: imageUrl
          });
          showToast('success', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
          exitEditMode();
        } else {
          await db.collection('villains').add({
            name, gang, location, crime, punishment, image: imageUrl, createdAt: new Date().toISOString()
          });
          showToast('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÅ‡∏≠‡∏ö‡∏ü‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          villainForm.reset();
          currentImageFile = null;
          currentImageUrl = null;
          imagePreview.innerHTML = '<span class="text-gray-400 text-sm text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>';
          formSection.classList.add('hidden');
        }
      } catch (error) {
        console.error('Form submit error:', error);
        showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
      }
      villainSubmitBtn.disabled = false;
      submitBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    });

    // Cancel Edit
    cancelEditBtn.addEventListener('click', () => {
      exitEditMode();
      villainForm.reset();
      currentImageFile = null;
      currentImageUrl = null;
      imagePreview.innerHTML = '<span class="text-gray-400 text-sm text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>';
    });

    // Exit Edit Mode
    function exitEditMode() {
      editingVillain = null;
      formTitle.textContent = '‡πÅ‡∏≠‡∏ö‡∏ü‡πâ‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏î‡∏∑‡πâ‡∏≠';
      submitBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      cancelEditBtn.classList.add('hidden');
    }

    // Render Villain Cards
    function renderVillainCards(filter = '') {
      const filtered = allVillains.filter(v => 
        v.name.toLowerCase().includes(filter.toLowerCase()) ||
        (v.gang && v.gang.toLowerCase().includes(filter.toLowerCase())) ||
        (v.crime && v.crime.toLowerCase().includes(filter.toLowerCase()))
      );
      if (filtered.length === 0) {
        cardsContainer.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      cardsContainer.innerHTML = filtered.map(villain => {
        const isAdmin = currentUser && currentUser.role === 'admin';
        return `
          <div class="villain-card bg-white rounded-2xl shadow-lg overflow-hidden relative">
            <div class="image-preview h-48 bg-gradient-to-br from-pink-100 to-orange-100">
              <img src="${villain.image}" alt="${villain.name}" class="w-full h-full" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
            </div>
            ${isAdmin ? `<button onclick="editVillain('${villain.id}')" class="action-btn absolute top-4 right-16 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-xl shadow-lg"><i data-lucide="edit" class="w-5 h-5"></i></button>` : ''}
            ${isAdmin ? `<button onclick="deleteVillain('${villain.id}')" class="action-btn absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white p-2 rounded-xl shadow-lg"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
            <div class="p-6">
              <h3 class="text-xl font-bold text-pink-600 mb-2">${villain.name}</h3>
              ${villain.gang ? `<div class="flex items-center text-sm text-gray-600 mb-2"><i data-lucide="users" class="w-4 h-4 mr-2"></i><span class="font-kanit">${villain.gang}</span></div>` : ''}
              ${villain.location ? `<div class="flex items-center text-sm text-gray-600 mb-2"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i><span class="font-kanit">${villain.location}</span></div>` : ''}
              ${villain.crime ? `<div class="mt-3 p-3 bg-orange-50 rounded-xl"><p class="text-sm text-gray-700 font-kanit">${villain.crime}</p></div>` : ''}
              <div class="mt-4 inline-block px-4 py-2 bg-pink-100 text-pink-700 rounded-full text-sm font-kanit">${villain.punishment}</div>
            </div>
          </div>
        `;
      }).join('');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Edit Villain (Admin Only)
    function editVillain(villainId) {
      if (currentUser.role !== 'admin') return;
      editingVillain = allVillains.find(v => v.id === villainId);
      if (!editingVillain) return;
      document.getElementById('nameInput').value = editingVillain.name;
      document.getElementById('gangInput').value = editingVillain.gang || '';
      document.getElementById('locationInput').value = editingVillain.location || '';
      document.getElementById('crimeInput').value = editingVillain.crime || '';
      document.getElementById('punishmentInput').value = editingVillain.punishment;
      if (editingVillain.image) {
        currentImageUrl = editingVillain.image;
        imagePreview.innerHTML = `<img src="${editingVillain.image}" alt="Preview" class="w-full h-full object-cover rounded-2xl">`;
      }
      formTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      submitBtnText.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
      cancelEditBtn.classList.remove('hidden');
      formSection.classList.remove('hidden');
      formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Delete Villain (Admin Only)
    async function deleteVillain(villainId) {
      if (currentUser.role !== 'admin') return;
      const villain = allVillains.find(v => v.id === villainId);
      if (!villain) return;
      const result = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
        text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${villain.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });
      if (result.isConfirmed) {
        try {
          await db.collection('villains').doc(villainId).delete();
          if (villain.image && villain.image.includes('firebase')) {
            try {
              const imageRef = storage.refFromURL(villain.image);
              await imageRef.delete();
            } catch (imgError) {
              console.log('‚ö†Ô∏è Could not delete image:', imgError.message);
            }
          }
          showToast('success', '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
          console.error('Delete villain error:', error);
          showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ');
        }
      }
    }

    // Search
    searchInput.addEventListener('input', (e) => {
      renderVillainCards(e.target.value);
    });

    // Toast Helper
    function showToast(icon, title, text) {
      return Swal.fire({
        icon: icon,
        title: title,
        text: text,
        timer: icon === 'success' ? 1500 : 3000,
        showConfirmButton: icon !== 'success',
        confirmButtonColor: '#ec4899'
      });
    }

    // Make functions global
    window.editVillain = editVillain;
    window.deleteVillain = deleteVillain;
    window.deleteUser = deleteUser; // Ensure this is linked
    window.openEditUserModal = openEditUserModal;
    window.closeEditUserModal = closeEditUserModal;

    // Start App
    initApp();
  </script>
 </body>
</html>